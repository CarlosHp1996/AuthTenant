=========================================================
UNAUTHORIZEDTENANTACCESSEXCEPTION.CS - DOCUMENTAÃ‡ÃƒO TÃ‰CNICA
=========================================================

VISÃƒO GERAL:
-----------
ExceÃ§Ã£o de seguranÃ§a lanÃ§ada quando tentativas de acesso nÃ£o autorizado a tenants sÃ£o detectadas.
Representa violaÃ§Ãµes de isolamento multi-tenant, tentativas de acesso cross-tenant e falhas de autorizaÃ§Ã£o.
Fornece contexto rico para auditoria de seguranÃ§a e detecÃ§Ã£o de ameaÃ§as.

LOCALIZAÃ‡ÃƒO:
-----------
ğŸ“ AuthTenant.Domain/Exceptions/UnauthorizedTenantAccessException.cs

DEPENDÃŠNCIAS:
------------
âœ… DomainException - HeranÃ§a de funcionalidades base
âœ… System.ComponentModel.DataAnnotations - ValidaÃ§Ãµes de dados
âœ… ExceptionSeverity - Enum de severidade de seguranÃ§a
âœ… System.Linq - OperaÃ§Ãµes de anÃ¡lise de dados

RESPONSABILIDADES:
-----------------
ğŸ”¸ Detectar e reportar violaÃ§Ãµes de seguranÃ§a multi-tenant
ğŸ”¸ Auditar tentativas de acesso cross-tenant
ğŸ”¸ Contextualizar ameaÃ§as e padrÃµes suspeitos
ğŸ”¸ Fornecer dados para sistemas de seguranÃ§a
ğŸ”¸ Mascarar informaÃ§Ãµes sensÃ­veis em logs
ğŸ”¸ Categorizar tipos de violaÃ§Ãµes de acesso

PROPRIEDADES DE SEGURANÃ‡A:
-------------------------

1. CONTEXTO DO ACESSO:
   âœ… RequestedTenantId (string?) - Tenant solicitado
   âœ… UserTenantId (string?) - Tenant do usuÃ¡rio
   âœ… AccessType (string) - Tipo de acesso tentado
   âœ… RequestedResource (string?) - Recurso especÃ­fico
   âœ… DetecÃ§Ã£o de tentativas cross-tenant

2. CONTEXTO DA OPERAÃ‡ÃƒO:
   âœ… OperationId (string?) - Identificador da operaÃ§Ã£o
   âœ… SourceIpAddress (string?) - IP de origem
   âœ… UserAgent (string?) - User agent da aplicaÃ§Ã£o
   âœ… AttemptedAt (DateTime) - Timestamp da tentativa
   âœ… Rastreamento completo da requisiÃ§Ã£o

3. ANÃLISE DE AMEAÃ‡AS:
   âœ… IsSuspiciousAttempt (bool) - DetecÃ§Ã£o de atividade suspeita
   âœ… ThreatIndicators (List<string>) - Indicadores de ameaÃ§a
   âœ… SecurityLevel (string) - NÃ­vel de severidade
   âœ… IsCrossTenantAttempt (bool) - Flag de acesso cross-tenant

TIPOS DE ACESSO MONITORADOS:
---------------------------

ğŸ” **Read** - Tentativas de leitura nÃ£o autorizadas
   â€¢ VisualizaÃ§Ã£o de dados protegidos
   â€¢ EnumeraÃ§Ã£o de recursos
   â€¢ Information gathering

ğŸ” **Write** - Tentativas de modificaÃ§Ã£o nÃ£o autorizadas
   â€¢ AlteraÃ§Ã£o de dados
   â€¢ CriaÃ§Ã£o de recursos
   â€¢ Updates maliciosos

ğŸ” **Delete** - Tentativas de remoÃ§Ã£o nÃ£o autorizadas
   â€¢ ExclusÃ£o de dados crÃ­ticos
   â€¢ Sabotagem de recursos
   â€¢ Data destruction

ğŸ” **Admin** - Tentativas de acesso administrativo
   â€¢ Privilege escalation
   â€¢ Configuration changes
   â€¢ System administration

ğŸ” **CrossTenant** - Tentativas de acesso entre tenants
   â€¢ Data breach attempts
   â€¢ Unauthorized data access
   â€¢ Tenant isolation violations

ğŸ” **NoTenant** - Acesso sem contexto de tenant vÃ¡lido
   â€¢ Bypass de isolation
   â€¢ System-level access
   â€¢ Configuration exploitation

SEVERIDADE AUTOMÃTICA:
---------------------

ğŸŸ¡ **Medium** - Read access violations
   â€¢ Tentativas de leitura nÃ£o autorizadas
   â€¢ EnumeraÃ§Ã£o bÃ¡sica de recursos
   â€¢ Exploratory attacks

ğŸŸ  **High** - Write/Delete access violations
   â€¢ Tentativas de modificaÃ§Ã£o de dados
   â€¢ Cross-tenant access attempts
   â€¢ Data manipulation attempts

ğŸ”´ **Critical** - Admin access violations
   â€¢ Privilege escalation attempts
   â€¢ System-level access attempts
   â€¢ Administrative bypass attempts

DETECÃ‡ÃƒO DE AMEAÃ‡AS:
-------------------

ğŸš¨ **DetermineSuspiciousActivity():**
   - Admin access sempre flagrado como suspeito
   - Recursos sensÃ­veis (user, admin, config, billing, security)
   - IPs suspeitos (locais em produÃ§Ã£o, ranges conhecidos)
   - PadrÃµes de comportamento anÃ´malos

ğŸš¨ **GetThreatIndicators():**
   - ADMIN_ACCESS_ATTEMPT
   - SENSITIVE_RESOURCE_ACCESS
   - INTERNAL_IP_ACCESS
   - CROSS_TENANT_VIOLATION
   - ENUMERATION_PATTERN
   - PRIVILEGE_ESCALATION

MASCARAMENTO DE DADOS:
---------------------

ğŸ­ **MaskIpAddress():**
   ```csharp
   // IPv4: 192.168.1.100 â†’ 192.168.xxx.xxx
   // IPv6: 2001:db8::1 â†’ 2001:db8:xxxx
   ```

ğŸ­ **TruncateUserAgent():**
   ```csharp
   // Limita a 200 caracteres + "..."
   ```

ğŸ­ **Context Sanitization:**
   - Remove informaÃ§Ãµes sensÃ­veis
   - Preserva dados Ãºteis para auditoria
   - Compliance com LGPD/GDPR

FACTORY METHODS DE SEGURANÃ‡A:
----------------------------

ğŸ­ **ForCrossTenantAccess():**
   ```csharp
   ForCrossTenantAccess(requestedTenantId, userTenantId, userId, resource)
   ```
   - Para violaÃ§Ãµes de isolamento entre tenants
   - Severidade High automÃ¡tica
   - Context rico para investigaÃ§Ã£o

ğŸ­ **ForAdminAccess():**
   ```csharp
   ForAdminAccess(tenantId, userId, operation, sourceIp)
   ```
   - Para tentativas de acesso administrativo
   - Severidade Critical automÃ¡tica
   - MÃ¡xima auditoria e alertas

ğŸ­ **ForUserWithoutTenant():**
   ```csharp
   ForUserWithoutTenant(userId, sourceIp)
   ```
   - Para usuÃ¡rios sem contexto de tenant
   - Bypass de isolation detection
   - Security policy violation

CONTEXTO ESTRUTURADO:
--------------------

ğŸ—‚ï¸ **Contexto AutomÃ¡tico de SeguranÃ§a:**
   ```json
   {
     "requestedTenantId": "tenant-123",
     "userTenantId": "tenant-456",
     "accessType": "CrossTenant",
     "requestedResource": "Products",
     "operationId": "GetProducts",
     "sourceIpAddress": "192.168.xxx.xxx",
     "userAgent": "Mozilla/5.0...",
     "attemptedAt": "2024-01-15T10:30:00Z",
     "isSuspiciousAttempt": true,
     "isCrossTenantAttempt": true,
     "securityLevel": "High",
     "threatIndicators": [
       "CROSS_TENANT_VIOLATION",
       "SENSITIVE_RESOURCE_ACCESS"
     ]
   }
   ```

INTEGRAÃ‡ÃƒO COM SEGURANÃ‡A:
------------------------
ğŸ”— **SIEM Systems** - Export estruturado de eventos
ğŸ”— **WAF Integration** - Blocking de IPs suspeitos
ğŸ”— **Rate Limiting** - Throttling de tentativas
ğŸ”— **Audit Trail** - Compliance e investigaÃ§Ã£o
ğŸ”— **Alerting** - NotificaÃ§Ã£o em tempo real
ğŸ”— **Threat Intelligence** - Enriquecimento de dados

CENÃRIOS DE SEGURANÃ‡A:
---------------------
âœ… **Cross-Tenant Data Breach** - Tentativa de acesso a dados de outros tenants
âœ… **Privilege Escalation** - UsuÃ¡rio tenta acessar recursos administrativos
âœ… **Enumeration Attack** - Varredura sistemÃ¡tica de recursos
âœ… **Insider Threat** - UsuÃ¡rio legÃ­timo com acesso suspeito
âœ… **API Abuse** - Uso indevido de endpoints protegidos
âœ… **Session Hijacking** - Tentativa de usar sessÃ£o de outro usuÃ¡rio

EXEMPLO DE IMPLEMENTAÃ‡ÃƒO:
------------------------
```csharp
// Middleware de seguranÃ§a
public class TenantSecurityMiddleware
{
    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        var currentUser = context.User;
        var requestedTenant = ExtractTenantFromRequest(context.Request);
        var userTenant = ExtractUserTenant(currentUser);
        
        // VerificaÃ§Ã£o cross-tenant
        if (!string.IsNullOrEmpty(requestedTenant) && 
            !string.IsNullOrEmpty(userTenant) && 
            requestedTenant != userTenant)
        {
            var sourceIp = GetClientIpAddress(context);
            var userAgent = context.Request.Headers["User-Agent"];
            var operation = $"{context.Request.Method} {context.Request.Path}";
            
            throw UnauthorizedTenantAccessException.ForCrossTenantAccess(
                requestedTenant, 
                userTenant, 
                currentUser.FindFirst("id")?.Value,
                ExtractResourceFromPath(context.Request.Path))
                .WithProperty("SourceIP", sourceIp)
                .WithProperty("UserAgent", userAgent)
                .WithProperty("Operation", operation)
                .WithCorrelationId(GetCorrelationId(context));
        }
        
        await next(context);
    }
}
```

EXEMPLO DE USO EM SERVIÃ‡OS:
--------------------------
```csharp
// Repository com proteÃ§Ã£o
public async Task<IEnumerable<Product>> GetProductsAsync(
    string tenantId, 
    string userId)
{
    var currentUserTenant = await GetUserTenantAsync(userId);
    
    if (currentUserTenant != tenantId)
    {
        throw UnauthorizedTenantAccessException.ForCrossTenantAccess(
            requestedTenantId: tenantId,
            userTenantId: currentUserTenant,
            userId: userId,
            resource: "Products");
    }
    
    return await _context.Products
        .Where(p => p.TenantId == tenantId)
        .ToListAsync();
}

// Service com auditoria
public async Task DeleteProductAsync(string productId, string userId)
{
    var user = await GetUserAsync(userId);
    
    if (!user.HasRole("Admin"))
    {
        throw UnauthorizedTenantAccessException.ForAdminAccess(
            tenantId: user.TenantId,
            userId: userId,
            operation: "DeleteProduct",
            sourceIp: GetCurrentRequestIp());
    }
    
    // Continua com a operaÃ§Ã£o...
}
```

TRATAMENTO EM CONTROLLERS:
-------------------------
```csharp
[HttpGet("{tenantId}/products")]
public async Task<IActionResult> GetProducts(string tenantId)
{
    try
    {
        var userId = User.FindFirst("id")?.Value;
        var products = await _productService.GetProductsAsync(tenantId, userId);
        return Ok(products);
    }
    catch (UnauthorizedTenantAccessException ex)
    {
        // Log de seguranÃ§a
        _securityLogger.LogSecurityViolation(ex.ToJson());
        
        // Alerta em tempo real para High/Critical
        if (ex.Severity >= ExceptionSeverity.High)
        {
            await _alertingService.SendSecurityAlertAsync(ex);
        }
        
        // Rate limiting para IP suspeito
        if (ex.IsSuspiciousAttempt)
        {
            await _rateLimitingService.BlockIpAsync(ex.SourceIpAddress);
        }
        
        // Resposta genÃ©rica para nÃ£o vazar informaÃ§Ãµes
        return Forbid("Acesso negado ao recurso solicitado");
    }
}
```

COMPLIANCE E AUDITORIA:
----------------------

ğŸ“‹ **LGPD/GDPR Compliance:**
   - Mascaramento automÃ¡tico de dados pessoais
   - Right to erasure support
   - Data processing lawfulness

ğŸ“‹ **SOX Compliance:**
   - Audit trail completo
   - Segregation of duties
   - Financial data protection

ğŸ“‹ **ISO 27001:**
   - Access control monitoring
   - Security incident management
   - Risk assessment data

ğŸ“‹ **PCI-DSS:**
   - Cardholder data protection
   - Access logging
   - Security testing evidence

MÃ‰TRICAS DE SEGURANÃ‡A:
---------------------
ğŸ“Š **Security KPIs:**
   - Unauthorized access attempts per day
   - Cross-tenant violations rate
   - Admin access violation trends
   - Suspicious activity patterns

ğŸ“Š **Threat Detection:**
   - Real-time anomaly detection
   - Behavioral analysis
   - Geographic pattern analysis
   - Time-based access patterns

ğŸ“Š **Response Metrics:**
   - Mean time to detection (MTTD)
   - Mean time to response (MTTR)
   - False positive rate
   - Security team efficiency

ALERTING E ESCALAÃ‡ÃƒO:
--------------------

ğŸš¨ **Immediate Alerts (Critical):**
   - Admin access violations
   - Mass data access attempts
   - Known attack patterns

ğŸš¨ **Hourly Alerts (High):**
   - Cross-tenant violations
   - Sensitive resource access
   - Repeated violations

ğŸš¨ **Daily Alerts (Medium):**
   - Unusual access patterns
   - Geographic anomalies
   - New device access

EXTENSÃ•ES DE SEGURANÃ‡A:
----------------------
ğŸ”® **Machine Learning** - Behavioral anomaly detection
ğŸ”® **Threat Intelligence** - Integration with threat feeds
ğŸ”® **Geolocation** - Geographic access analysis
ğŸ”® **Device Fingerprinting** - Device-based security
ğŸ”® **Risk Scoring** - Comprehensive risk assessment
ğŸ”® **Automated Response** - Immediate threat mitigation

PERFORMANCE DE SEGURANÃ‡A:
------------------------
âš¡ Minimal overhead em operaÃ§Ãµes normais
âš¡ Async security logging para nÃ£o bloquear requests
âš¡ Cached security policies
âš¡ Optimized threat detection algorithms
âš¡ Lazy evaluation de contexto complexo

TESTES DE SEGURANÃ‡A:
-------------------
ğŸ§ª **Unit Tests** - CenÃ¡rios de violaÃ§Ã£o isolados
ğŸ§ª **Integration Tests** - Fluxos completos de seguranÃ§a
ğŸ§ª **Penetration Tests** - SimulaÃ§Ã£o de ataques reais
ğŸ§ª **Load Tests** - Performance sob pressÃ£o
ğŸ§ª **Chaos Engineering** - Resilience testing

CONSIDERAÃ‡Ã•ES DE ARQUITETURA:
-----------------------------
âš ï¸ **Defense in Depth** - MÃºltiplas camadas de proteÃ§Ã£o
âš ï¸ **Fail Secure** - Falhas devem bloquear acesso
âš ï¸ **Least Privilege** - Acesso mÃ­nimo necessÃ¡rio
âš ï¸ **Zero Trust** - VerificaÃ§Ã£o contÃ­nua
âš ï¸ **Audit Everything** - Log completo de atividades
âš ï¸ **Assume Breach** - DetecÃ§Ã£o rÃ¡pida de violaÃ§Ãµes

VERSIONAMENTO:
-------------
ğŸ“‹ VersÃ£o: 2.0.0
ğŸ“‹ Ãšltima AtualizaÃ§Ã£o: 2024
ğŸ“‹ Compatibilidade: .NET 8+
ğŸ“‹ Security Level: High
ğŸ“‹ Threat Detection: Advanced
ğŸ“‹ Status: ProduÃ§Ã£o

AUTOR & RESPONSÃVEL:
-------------------
ğŸ‘¨â€ğŸ’» Desenvolvido por: Equipe AuthTenant Security
ğŸ‘¨â€ğŸ’» Mantido por: Time de Security & Compliance
ğŸ“§ Contato: security@AuthTenant.com
ğŸ”— DocumentaÃ§Ã£o: docs.AuthTenant.com/security/tenant-access
ğŸš¨ Security Issues: security-alerts@AuthTenant.com

=========================================================
