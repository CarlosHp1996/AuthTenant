=========================================================
PRODUCTCREATEDEVENT.CS - DOCUMENTAÃ‡ÃƒO TÃ‰CNICA
=========================================================

VISÃƒO GERAL:
-----------
Evento de domÃ­nio especializado disparado quando um novo produto Ã© criado.
Implementa comunicaÃ§Ã£o assÃ­ncrona entre bounded contexts para orquestrar
processos de integraÃ§Ã£o, indexaÃ§Ã£o, notificaÃ§Ãµes e analytics.
Segue padrÃµes DDD com rich context e immutability.

LOCALIZAÃ‡ÃƒO:
-----------
ğŸ“ AuthTenant.Domain/Events/ProductCreatedEvent.cs

DEPENDÃŠNCIAS:
------------
âœ… DomainEvent - Classe base com funcionalidades comuns
âœ… Product - Entidade de domÃ­nio do produto
âœ… System.ComponentModel.DataAnnotations - ValidaÃ§Ãµes
âœ… System.Text.Json - ManipulaÃ§Ã£o de metadados JSON

RESPONSABILIDADES:
-----------------
ğŸ”¸ Notificar criaÃ§Ã£o de produtos para sistemas dependentes
ğŸ”¸ Orquestrar processos de indexaÃ§Ã£o e search
ğŸ”¸ Trigger de emails e notificaÃ§Ãµes administrativas
ğŸ”¸ Alimentar sistemas de analytics e metrics
ğŸ”¸ Sincronizar dados com sistemas externos
ğŸ”¸ Auditoria detalhada de criaÃ§Ãµes de produto

PROPRIEDADES PRINCIPAIS:
-----------------------

1. DADOS DO PRODUTO:
   âœ… Product (Product) - Entidade completa do produto criado
   âœ… ValidaÃ§Ã£o de nÃ£o-nulidade e consistÃªncia
   âœ… Acesso a todas as propriedades do produto
   âœ… InformaÃ§Ãµes completas para processamento

2. CONTEXTO DE CRIAÃ‡ÃƒO:
   âœ… Context (ProductCreationContext) - Contexto detalhado
   âœ… Source - Origem da criaÃ§Ã£o (Web, API, Import)
   âœ… CreatedAt - Timestamp especÃ­fico da criaÃ§Ã£o
   âœ… ImportBatch - ID do lote de importaÃ§Ã£o (se aplicÃ¡vel)
   âœ… ApiVersion - VersÃ£o da API usada (se aplicÃ¡vel)
   âœ… AdditionalData - Dados contextuais extras

3. HERANÃ‡A DE DOMAINEVENT:
   âœ… Id, TenantId, UserId - IdentificaÃ§Ã£o e auditoria
   âœ… OccurredOn, Version - Timestamp e versionamento
   âœ… CorrelationId, Metadata - Rastreabilidade distribuÃ­da

CONSTRUTOR PRINCIPAL:
--------------------

ğŸ”§ ProductCreatedEvent(product, tenantId, userId?, source, correlationId?)
   - ConstruÃ§Ã£o controlada com validaÃ§Ãµes
   - ParÃ¢metros obrigatÃ³rios: product, tenantId
   - ParÃ¢metros opcionais com defaults sensatos
   - ValidaÃ§Ã£o de argumentos no momento da criaÃ§Ã£o
   - Context gerado automaticamente com timestamp

VALIDAÃ‡Ã•ES DE NEGÃ“CIO:
---------------------

1. PRODUTO:
   âŒ Product nÃ£o pode ser nulo
   âŒ Product deve estar vÃ¡lido (Product.IsValid())
   âŒ Product.Name nÃ£o pode ser vazio
   âŒ Product.TenantId deve corresponder ao evento

2. TENANT:
   âŒ TenantId obrigatÃ³rio e nÃ£o-vazio
   âŒ ConsistÃªncia entre Product.TenantId e Event.TenantId
   âŒ Formato vÃ¡lido de identificador

3. CONTEXTO:
   âŒ Source nÃ£o pode ser nulo ou vazio
   âŒ CreatedAt nÃ£o pode ser no futuro
   âŒ ImportBatch vÃ¡lido se fornecido
   âŒ ApiVersion com formato esperado

MÃ‰TODOS IMPLEMENTADOS:
---------------------

ğŸ”§ IsValid() : bool (override)
   - ValidaÃ§Ã£o completa da estrutura do evento
   - Chama validaÃ§Ã£o base + validaÃ§Ãµes especÃ­ficas
   - Verifica consistÃªncia Product â†” Event
   - Garante integridade antes do dispatch

ğŸ”§ WithCorrelationId(Guid newCorrelationId) : DomainEvent (override)
   - Cria nova instÃ¢ncia com correlation ID atualizado
   - MantÃ©m imutabilidade do record
   - Suporte a distributed tracing
   - Preserva todos os outros dados

ğŸ”§ WithMetadata(string additionalMetadata) : DomainEvent (override)
   - Merge inteligente de metadados JSON
   - Combina metadados existentes com novos
   - Tratamento de erro gracioso
   - Extensibilidade sem breaking changes

ğŸ”§ ToString() : string (override)
   - Logging estruturado e debugging
   - InformaÃ§Ãµes essenciais do produto
   - Contexto de criaÃ§Ã£o incluÃ­do
   - Formato legÃ­vel para troubleshooting

CONTEXT CLASS - PRODUCTCREATIONCONTEXT:
--------------------------------------

ğŸ“‹ PROPRIEDADES:
   âœ… Source - Origem: "Web", "API", "Import", "SSO"
   âœ… CreatedAt - Timestamp especÃ­fico da criaÃ§Ã£o
   âœ… ImportBatch - ID do lote (para imports em massa)
   âœ… ApiVersion - VersÃ£o da API (para chamadas API)
   âœ… AdditionalData - Dictionary para dados extras

ğŸ“‹ PROPRIEDADES COMPUTADAS:
   ğŸ”§ IsImportCreation - Detecta criaÃ§Ã£o via import
   ğŸ”§ IsApiCreation - Detecta criaÃ§Ã£o via API
   ğŸ”§ TimeSinceCreation - Tempo decorrido desde criaÃ§Ã£o

CASOS DE USO TÃPICOS:
--------------------

1. **CRIAÃ‡ÃƒO VIA WEB INTERFACE:**
   ```csharp
   var evt = new ProductCreatedEvent(
       product: newProduct,
       tenantId: "tenant-123",
       userId: "user-456",
       source: "Web"
   );
   ```

2. **IMPORTAÃ‡ÃƒO EM LOTE:**
   ```csharp
   var context = new ProductCreationContext(
       Source: "Import",
       CreatedAt: DateTime.UtcNow,
       ImportBatch: "batch-2024-001"
   );
   ```

3. **CRIAÃ‡ÃƒO VIA API:**
   ```csharp
   var evt = new ProductCreatedEvent(
       product: apiProduct,
       tenantId: tenant,
       source: "API",
       correlationId: requestCorrelationId
   );
   ```

HANDLERS TÃPICOS:
----------------

ğŸ”§ **Search Indexing Handler:**
   - Indexa produto no Elasticsearch
   - Atualiza Ã­ndices de busca
   - Configura anÃ¡lise de texto

ğŸ”§ **Analytics Handler:**
   - Registra mÃ©tricas de criaÃ§Ã£o
   - Atualiza dashboards
   - Alimenta relatÃ³rios

ğŸ”§ **Notification Handler:**
   - Emails para administradores
   - NotificaÃ§Ãµes push
   - Webhooks para integraÃ§Ãµes

ğŸ”§ **Cache Invalidation Handler:**
   - Limpa caches relacionados
   - Atualiza cached queries
   - Refresh de views materializadas

ğŸ”§ **External Integration Handler:**
   - Sincroniza com ERP
   - Atualiza catÃ¡logos externos
   - Notifica marketplaces

EXEMPLO COMPLETO DE USO:
-----------------------

```csharp
// 1. No Agregado Product
public class Product : BaseEntity
{
    public static Product Create(string name, decimal price, string tenantId, string createdBy)
    {
        var product = new Product
        {
            Id = Guid.NewGuid().ToString(),
            Name = name,
            Price = price,
            TenantId = tenantId,
            CreatedBy = createdBy,
            CreatedAt = DateTime.UtcNow
        };

        // Adiciona evento de domÃ­nio
        product.AddDomainEvent(new ProductCreatedEvent(
            product: product,
            tenantId: tenantId,
            userId: createdBy,
            source: "Web"
        ));

        return product;
    }
}

// 2. Handler para IndexaÃ§Ã£o
public class ProductCreatedIndexingHandler : INotificationHandler<ProductCreatedEvent>
{
    private readonly ISearchService _searchService;

    public async Task Handle(ProductCreatedEvent notification, CancellationToken ct)
    {
        var product = notification.Product;
        
        var searchDocument = new ProductSearchDocument
        {
            Id = product.Id,
            Name = product.Name,
            Description = product.Description,
            Price = product.Price,
            TenantId = product.TenantId,
            CreatedAt = notification.OccurredOn
        };

        await _searchService.IndexAsync(searchDocument, ct);
        
        _logger.LogInformation(
            "Product {ProductId} indexed for tenant {TenantId}",
            product.Id, product.TenantId);
    }
}

// 3. Handler para Analytics
public class ProductCreatedAnalyticsHandler : INotificationHandler<ProductCreatedEvent>
{
    public async Task Handle(ProductCreatedEvent notification, CancellationToken ct)
    {
        var metrics = new ProductCreationMetrics
        {
            ProductId = notification.Product.Id,
            TenantId = notification.TenantId,
            Source = notification.Context.Source,
            Category = notification.Product.Category,
            Price = notification.Product.Price,
            CreatedAt = notification.OccurredOn
        };

        await _analyticsService.RecordAsync(metrics, ct);
    }
}

// 4. Dispatch no Application Service
public class CreateProductCommandHandler : IRequestHandler<CreateProductCommand, Result<string>>
{
    public async Task<Result<string>> Handle(CreateProductCommand request, CancellationToken ct)
    {
        var product = Product.Create(
            request.Name, 
            request.Price, 
            request.TenantId, 
            request.CreatedBy);

        await _productRepository.AddAsync(product, ct);
        
        // MediatR automaticamente dispatcha os eventos de domÃ­nio
        await _unitOfWork.SaveChangesAsync(ct);
        
        return Result<string>.Success(product.Id);
    }
}
```

INTEGRAÃ‡ÃƒO COM SISTEMA:
----------------------

ğŸ”— **MediatR Pipeline:**
   - Dispatch automÃ¡tico apÃ³s SaveChanges
   - Processamento assÃ­ncrono de handlers
   - Retry policies para handlers crÃ­ticos

ğŸ”— **Event Store (futuro):**
   - PersistÃªncia de eventos para replay
   - Audit trail completo
   - Event sourcing capabilities

ğŸ”— **Message Bus:**
   - PublicaÃ§Ã£o para sistemas externos
   - Eventual consistency entre contextos
   - Integration events derivados

PERFORMANCE E ESCALABILIDADE:
----------------------------

âš¡ Record imutÃ¡vel para performance
âš¡ Lazy evaluation de propriedades computadas
âš¡ SerializaÃ§Ã£o otimizada para JSON
âš¡ Handlers processados em paralelo
âš¡ Batching para operaÃ§Ãµes bulk

MONITORAMENTO E OBSERVABILIDADE:
-------------------------------

ğŸ“Š MÃ©tricas de dispatch time
ğŸ“Š Taxa de sucesso de handlers
ğŸ“Š LatÃªncia de processamento
ğŸ“Š Alertas para falhas crÃ­ticas
ğŸ“Š Dashboard de eventos por tenant

TROUBLESHOOTING:
---------------

ğŸ” **Evento nÃ£o processado:**
   - Verificar registro de handlers no DI
   - Validar evento com IsValid()
   - Checar logs de exceÃ§Ãµes em handlers

ğŸ” **Performance degradada:**
   - Monitorar tempo de handlers
   - Verificar queries N+1 em handlers
   - Analisar locks e deadlocks

ğŸ” **InconsistÃªncias:**
   - Validar TenantId consistency
   - Verificar timing de saveChanges
   - Checar ordem de processamento

EXTENSÃ•ES FUTURAS:
-----------------

ğŸ”® Product Variants Created - Para variaÃ§Ãµes
ğŸ”® Product Imported Event - Para imports especÃ­ficos
ğŸ”® Product Approved Event - Para workflows de aprovaÃ§Ã£o
ğŸ”® Product Rejected Event - Para validaÃ§Ãµes falhadas
ğŸ”® Product Cloned Event - Para duplicaÃ§Ãµes

VERSIONAMENTO:
-------------

ğŸ“‹ VersÃ£o: 2.0.0
ğŸ“‹ Ãšltima AtualizaÃ§Ã£o: 2024
ğŸ“‹ Compatibilidade: .NET 8+ / MediatR 12+
ğŸ“‹ Status: ProduÃ§Ã£o

AUTOR & RESPONSÃVEL:
-------------------

ğŸ‘¨â€ğŸ’» Desenvolvido por: Equipe AuthTenant
ğŸ‘¨â€ğŸ’» Mantido por: Time de Products
ğŸ“§ Contato: products@AuthTenant.com

=========================================================
