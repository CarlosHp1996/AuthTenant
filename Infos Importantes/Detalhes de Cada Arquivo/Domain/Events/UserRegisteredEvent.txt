=========================================================
USERREGISTEREDEVENT.CS - DOCUMENTAÃ‡ÃƒO TÃ‰CNICA
=========================================================

VISÃƒO GERAL:
-----------
Evento de domÃ­nio especializado disparado quando um novo usuÃ¡rio se registra.
Orquestra processos crÃ­ticos de onboarding, configuraÃ§Ã£o inicial, envio de emails
de boas-vindas, verificaÃ§Ã£o de identidade e integraÃ§Ã£o com sistemas externos.
Implementa rich context para diferentes origens de registro.

LOCALIZAÃ‡ÃƒO:
-----------
ğŸ“ AuthTenant.Domain/Events/UserRegisteredEvent.cs

DEPENDÃŠNCIAS:
------------
âœ… DomainEvent - Classe base com funcionalidades comuns
âœ… ApplicationUser - Entidade de usuÃ¡rio do sistema
âœ… System.ComponentModel.DataAnnotations - ValidaÃ§Ãµes
âœ… System.Text.Json - ManipulaÃ§Ã£o de metadados JSON

RESPONSABILIDADES:
-----------------
ğŸ”¸ Orquestrar fluxo completo de onboarding de usuÃ¡rios
ğŸ”¸ Trigger de emails de boas-vindas e confirmaÃ§Ã£o
ğŸ”¸ ConfiguraÃ§Ã£o de perfis e preferÃªncias iniciais
ğŸ”¸ IntegraÃ§Ã£o com sistemas de CRM e analytics
ğŸ”¸ Auditoria de seguranÃ§a para novos registros
ğŸ”¸ SincronizaÃ§Ã£o com provedores de SSO

PROPRIEDADES PRINCIPAIS:
-----------------------

1. DADOS DO USUÃRIO:
   âœ… User (ApplicationUser) - Entidade completa do usuÃ¡rio
   âœ… InformaÃ§Ãµes de perfil, email e configuraÃ§Ãµes
   âœ… Dados de tenant e associaÃ§Ãµes
   âœ… ValidaÃ§Ã£o de consistÃªncia e integridade

2. FLAGS DE COMPORTAMENTO:
   âœ… IsInvitedUser (bool) - Registro via convite
   âœ… IsEmailPreConfirmed (bool) - Email jÃ¡ confirmado (SSO)
   âœ… RequiresEmailConfirmation - Computed property
   âœ… RequiresOnboarding - Computed property

3. CONTEXTO DE REGISTRO:
   âœ… Context (UserRegistrationContext) - Contexto detalhado
   âœ… Source - Origem: Web, API, Import, SSO
   âœ… RegisteredAt - Timestamp especÃ­fico
   âœ… InvitedBy - UsuÃ¡rio que enviou convite
   âœ… UserAgent, IpAddress - Dados de seguranÃ§a
   âœ… SSO Provider - Provedor de autenticaÃ§Ã£o

4. HERANÃ‡A DE DOMAINEVENT:
   âœ… Id, TenantId, UserId - IdentificaÃ§Ã£o
   âœ… OccurredOn, Version - Auditoria temporal
   âœ… CorrelationId, Metadata - Rastreabilidade

CONSTRUTOR PRINCIPAL:
--------------------

ğŸ”§ UserRegisteredEvent(user, tenantId, registrationSource, invitedBy?, isEmailPreConfirmed, userAgent?, ipAddress?, correlationId?)
   - ConstruÃ§Ã£o controlada com validaÃ§Ãµes rigorosas
   - ParÃ¢metros obrigatÃ³rios: user, tenantId
   - Context gerado automaticamente com dados de seguranÃ§a
   - DetecÃ§Ã£o automÃ¡tica de convites e SSO
   - ValidaÃ§Ã£o de argumentos crÃ­ticos

VALIDAÃ‡Ã•ES DE NEGÃ“CIO:
---------------------

1. USUÃRIO:
   âŒ User nÃ£o pode ser nulo
   âŒ User.Email nÃ£o pode ser vazio
   âŒ User.UserName nÃ£o pode ser vazio
   âŒ User.TenantId deve corresponder ao evento

2. TENANT E SEGURANÃ‡A:
   âŒ TenantId obrigatÃ³rio e nÃ£o-vazio
   âŒ ConsistÃªncia User.TenantId â†” Event.TenantId
   âŒ RegisteredAt nÃ£o pode ser no futuro
   âŒ Dados de contexto coerentes

3. EMAIL E CONFIRMAÃ‡ÃƒO:
   âŒ Email deve ter formato vÃ¡lido
   âŒ EmailPreConfirmed coerente com Source
   âŒ SSO sources devem ter email confirmado
   âŒ Convites devem ter InvitedBy vÃ¡lido

MÃ‰TODOS IMPLEMENTADOS:
---------------------

ğŸ”§ IsValid() : bool (override)
   - ValidaÃ§Ã£o completa da estrutura
   - Verifica consistÃªncia User â†” Event â†” Context
   - ValidaÃ§Ã£o de regras de negÃ³cio especÃ­ficas
   - Garante integridade para processamento

ğŸ”§ WithCorrelationId(Guid newCorrelationId) : DomainEvent (override)
   - Nova instÃ¢ncia com correlation ID
   - PreservaÃ§Ã£o de imutabilidade
   - Suporte a distributed tracing
   - ManutenÃ§Ã£o de todos os dados

ğŸ”§ WithMetadata(string additionalMetadata) : DomainEvent (override)
   - Merge inteligente de metadados JSON
   - Enriquecimento de contexto
   - Extensibilidade para integraÃ§Ãµes
   - Tratamento de erro gracioso

ğŸ”§ ToString() : string (override)
   - Logging estruturado para auditoria
   - InformaÃ§Ãµes essenciais do usuÃ¡rio
   - Contexto de registro incluÃ­do
   - Dados de seguranÃ§a mascarados

PROPRIEDADES COMPUTADAS:
------------------------

ğŸ”§ RequiresEmailConfirmation
   - LÃ³gica: !IsEmailPreConfirmed && !Context.IsSSO
   - Determina necessidade de email de confirmaÃ§Ã£o
   - Influencia fluxo de onboarding
   - Base para conditional workflows

ğŸ”§ RequiresOnboarding
   - LÃ³gica: !IsInvitedUser || Context.Source != "SSO"
   - Define necessidade de tour/configuraÃ§Ã£o inicial
   - Controla apresentaÃ§Ã£o de wizards
   - PersonalizaÃ§Ã£o de experiÃªncia

CONTEXT CLASS - USERREGISTRATIONCONTEXT:
----------------------------------------

ğŸ“‹ PROPRIEDADES BASE:
   âœ… Source - Web, API, Import, SSO
   âœ… RegisteredAt - Timestamp especÃ­fico
   âœ… InvitedBy - ID do usuÃ¡rio que convidou
   âœ… UserAgent - String do navegador/app
   âœ… IpAddress - EndereÃ§o IP de origem
   âœ… IsSSO - Flag de Single Sign-On
   âœ… SSOProvider - Google, Microsoft, etc.
   âœ… RegistrationToken - Token Ãºnico de registro
   âœ… AdditionalData - Dados contextuais extras

ğŸ“‹ PROPRIEDADES COMPUTADAS:
   ğŸ”§ IsInvitedRegistration - Detecta convites
   ğŸ”§ IsSSORegistration - Detecta SSO
   ğŸ”§ IsApiRegistration - Detecta API calls
   ğŸ”§ TimeSinceRegistration - Tempo decorrido
   ğŸ”§ GetLocationInfo() - Info geogrÃ¡fica do IP

CASOS DE USO TÃPICOS:
--------------------

1. **REGISTRO VIA WEB FORM:**
   ```csharp
   var evt = new UserRegisteredEvent(
       user: newUser,
       tenantId: "tenant-123",
       registrationSource: "Web",
       userAgent: "Mozilla/5.0...",
       ipAddress: "192.168.1.100"
   );
   ```

2. **REGISTRO VIA CONVITE:**
   ```csharp
   var evt = new UserRegisteredEvent(
       user: invitedUser,
       tenantId: tenant,
       registrationSource: "Web",
       invitedBy: "admin-user-id",
       userAgent: userAgent
   );
   ```

3. **REGISTRO VIA SSO:**
   ```csharp
   var evt = new UserRegisteredEvent(
       user: ssoUser,
       tenantId: tenant,
       registrationSource: "SSO",
       isEmailPreConfirmed: true,
       correlationId: ssoCorrelationId
   );
   ```

HANDLERS TÃPICOS:
----------------

ğŸ”§ **Welcome Email Handler:**
   - Envia email de boas-vindas personalizado
   - Templates diferentes por source/tenant
   - Anexa guias e recursos Ãºteis

ğŸ”§ **Email Confirmation Handler:**
   - Gera token de confirmaÃ§Ã£o
   - Envia email com link de ativaÃ§Ã£o
   - Configura expiraÃ§Ã£o do token

ğŸ”§ **Profile Setup Handler:**
   - Cria perfil inicial padrÃ£o
   - Configura preferÃªncias base
   - Associa roles e permissÃµes

ğŸ”§ **Analytics Handler:**
   - Registra mÃ©tricas de conversÃ£o
   - Alimenta funnel de onboarding
   - Tracking de origens de registro

ğŸ”§ **CRM Integration Handler:**
   - Sincroniza com sistema CRM
   - Cria lead ou contact
   - Atualiza dados de marketing

ğŸ”§ **Security Audit Handler:**
   - Log de auditoria de seguranÃ§a
   - VerificaÃ§Ã£o de IP suspicious
   - Alertas para padrÃµes anÃ´malos

EXEMPLO COMPLETO DE USO:
-----------------------

```csharp
// 1. No Application Service
public class RegisterUserCommandHandler : IRequestHandler<RegisterUserCommand, Result<string>>
{
    public async Task<Result<string>> Handle(RegisterUserCommand request, CancellationToken ct)
    {
        // Criar usuÃ¡rio
        var user = new ApplicationUser
        {
            UserName = request.Email,
            Email = request.Email,
            FirstName = request.FirstName,
            LastName = request.LastName,
            TenantId = request.TenantId,
            CreatedBy = "System"
        };

        var result = await _userManager.CreateAsync(user, request.Password);
        if (!result.Succeeded)
            return Result<string>.Failure("Falha ao criar usuÃ¡rio");

        // Disparar evento
        var evt = new UserRegisteredEvent(
            user: user,
            tenantId: request.TenantId,
            registrationSource: "Web",
            userAgent: request.UserAgent,
            ipAddress: request.IpAddress
        );

        await _mediator.Publish(evt, ct);
        
        return Result<string>.Success(user.Id);
    }
}

// 2. Handler para Email de Boas-vindas
public class UserRegisteredWelcomeEmailHandler : INotificationHandler<UserRegisteredEvent>
{
    private readonly IEmailService _emailService;
    private readonly ITenantService _tenantService;

    public async Task Handle(UserRegisteredEvent notification, CancellationToken ct)
    {
        var user = notification.User;
        var tenant = await _tenantService.GetByIdAsync(user.TenantId);
        
        var emailModel = new WelcomeEmailModel
        {
            UserName = user.FirstName ?? user.UserName,
            TenantName = tenant.DisplayName,
            IsInvitedUser = notification.IsInvitedUser,
            RequiresEmailConfirmation = notification.RequiresEmailConfirmation,
            DashboardUrl = $"https://{tenant.CustomDomain}/dashboard"
        };

        await _emailService.SendWelcomeEmailAsync(user.Email, emailModel, ct);
    }
}

// 3. Handler para ConfiguraÃ§Ã£o de Perfil
public class UserRegisteredProfileSetupHandler : INotificationHandler<UserRegisteredEvent>
{
    public async Task Handle(UserRegisteredEvent notification, CancellationToken ct)
    {
        var user = notification.User;
        
        // Configurar preferÃªncias padrÃ£o baseadas no tenant
        var tenant = await _tenantService.GetByIdAsync(user.TenantId);
        
        user.UpdatePreferences(
            timeZone: tenant.TimeZone ?? "UTC",
            language: tenant.Language ?? "en-US",
            notificationPrefs: GetDefaultNotificationPrefs(),
            updatedBy: "System"
        );

        // Adicionar roles padrÃ£o
        if (notification.IsInvitedUser)
        {
            await _userManager.AddToRoleAsync(user, "Member");
        }
        else
        {
            await _userManager.AddToRoleAsync(user, "Owner");
        }

        await _userRepository.UpdateAsync(user, ct);
    }
}

// 4. Handler para Analytics
public class UserRegisteredAnalyticsHandler : INotificationHandler<UserRegisteredEvent>
{
    public async Task Handle(UserRegisteredEvent notification, CancellationToken ct)
    {
        var metrics = new UserRegistrationMetrics
        {
            UserId = notification.User.Id,
            TenantId = notification.TenantId,
            Source = notification.Context.Source,
            IsInvited = notification.IsInvitedUser,
            IsSso = notification.Context.IsSSO,
            SsoProvider = notification.Context.SSOProvider,
            UserAgent = notification.Context.UserAgent,
            IpAddress = notification.Context.IpAddress,
            RegisteredAt = notification.OccurredOn
        };

        await _analyticsService.TrackUserRegistrationAsync(metrics, ct);
        
        // Atualizar mÃ©tricas do tenant
        await _tenantMetricsService.IncrementUserCountAsync(
            notification.TenantId, ct);
    }
}
```

FLUXOS DE ONBOARDING:
--------------------

ğŸ“‹ **USUÃRIO NORMAL (Web):**
   1. UserRegisteredEvent dispatched
   2. Welcome email enviado
   3. Email confirmation enviado
   4. Profile setup executado
   5. Analytics registrado
   6. Redirect para onboarding wizard

ğŸ“‹ **USUÃRIO CONVIDADO:**
   1. UserRegisteredEvent dispatched
   2. Welcome email personalizado
   3. Profile setup com role Member
   4. Analytics com source "Invite"
   5. Redirect direto para dashboard

ğŸ“‹ **USUÃRIO SSO:**
   1. UserRegisteredEvent dispatched
   2. Welcome email simplificado
   3. Profile setup automÃ¡tico
   4. Email jÃ¡ confirmado
   5. Redirect direto para aplicaÃ§Ã£o

INTEGRAÃ‡ÃƒO COM SISTEMA:
----------------------

ğŸ”— **Identity System:**
   - AspNetCore Identity integration
   - Role e claims assignment
   - Password policies enforcement

ğŸ”— **Email Service:**
   - Template-based emails
   - Personalization por tenant
   - Delivery tracking

ğŸ”— **Analytics Platform:**
   - Conversion funnel tracking
   - User acquisition metrics
   - A/B testing support

ğŸ”— **CRM Integration:**
   - Lead creation
   - Contact synchronization
   - Marketing automation triggers

SEGURANÃ‡A E COMPLIANCE:
----------------------

ğŸ”’ **Auditoria Completa:**
   - IP address logging
   - User agent tracking
   - Registration source validation
   - Correlation ID para compliance

ğŸ”’ **DetecÃ§Ã£o de Fraude:**
   - IP reputation checking
   - Velocity limits por IP
   - Pattern analysis
   - Suspicious activity alerts

ğŸ”’ **LGPD/GDPR Compliance:**
   - Consent tracking
   - Data minimization
   - Right to erasure support
   - Lawful basis documentation

MONITORAMENTO E MÃ‰TRICAS:
------------------------

ğŸ“Š **Registration Metrics:**
   - Taxa de conversÃ£o por source
   - Tempo mÃ©dio de onboarding
   - Email confirmation rates
   - User activation rates

ğŸ“Š **Security Metrics:**
   - Failed registration attempts
   - Suspicious IP addresses
   - Bot detection rates
   - Account takeover attempts

ğŸ“Š **Business Metrics:**
   - User acquisition cost
   - Lifetime value prediction
   - Churn prediction
   - Feature adoption rates

TROUBLESHOOTING:
---------------

ğŸ” **Emails nÃ£o enviados:**
   - Verificar handlers de email registrados
   - Checar configuraÃ§Ã£o SMTP/SendGrid
   - Validar templates de email
   - Monitorar bounce rates

ğŸ” **UsuÃ¡rios nÃ£o ativados:**
   - Verificar fluxo de email confirmation
   - Checar tokens de ativaÃ§Ã£o
   - Validar links de confirmaÃ§Ã£o
   - Monitorar spam folders

ğŸ” **SSO nÃ£o funcionando:**
   - Verificar configuraÃ§Ã£o de providers
   - Checar mapeamento de claims
   - Validar redirect URLs
   - Monitorar token validation

EXTENSÃ•ES FUTURAS:
-----------------

ğŸ”® User Email Confirmed Event
ğŸ”® User Profile Completed Event
ğŸ”® User First Login Event
ğŸ”® User Invited Event
ğŸ”® User Activation Reminder Event
ğŸ”® User Onboarding Completed Event

VERSIONAMENTO:
-------------

ğŸ“‹ VersÃ£o: 2.0.0
ğŸ“‹ Ãšltima AtualizaÃ§Ã£o: 2024
ğŸ“‹ Compatibilidade: .NET 8+ / Identity 8+
ğŸ“‹ Status: ProduÃ§Ã£o

AUTOR & RESPONSÃVEL:
-------------------

ğŸ‘¨â€ğŸ’» Desenvolvido por: Equipe AuthTenant
ğŸ‘¨â€ğŸ’» Mantido por: Time de Identity
ğŸ“§ Contato: identity@AuthTenant.com

=========================================================
